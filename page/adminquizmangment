import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Shield, Plus, Trash2, Users, BookOpen, Sparkles, Save } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Checkbox } from "@/components/ui/checkbox";
import { Alert, AlertDescription } from "@/components/ui/alert";

export default function AdminQuizManagement() {
  const navigate = useNavigate();
  const [currentUser, setCurrentUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [creating, setCreating] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState("");
  
  const [quizData, setQuizData] = useState({
    title: "",
    topic: "",
    difficulty: "medium",
    duration_minutes: 15,
    questions: [
      { question: "", options: ["", "", "", ""], correct_answer: "", explanation: "" }
    ],
    assigned_users: [],
    is_public: false
  });

  useEffect(() => {
    checkAdminAndLoadData();
  }, []);

  const checkAdminAndLoadData = async () => {
    try {
      const user = await base44.auth.me();
      setCurrentUser(user);

      if (user.role !== 'admin') {
        navigate(createPageUrl("Home"));
        return;
      }

      const allUsers = await base44.entities.User.list();
      setUsers(allUsers.filter(u => u.role !== 'admin'));
    } catch (err) {
      console.error(err);
      navigate(createPageUrl("Home"));
    }
    setLoading(false);
  };

  const addQuestion = () => {
    setQuizData({
      ...quizData,
      questions: [
        ...quizData.questions,
        { question: "", options: ["", "", "", ""], correct_answer: "", explanation: "" }
      ]
    });
  };

  const removeQuestion = (index) => {
    const newQuestions = quizData.questions.filter((_, i) => i !== index);
    setQuizData({ ...quizData, questions: newQuestions });
  };

  const updateQuestion = (index, field, value) => {
    const newQuestions = [...quizData.questions];
    newQuestions[index] = { ...newQuestions[index], [field]: value };
    setQuizData({ ...quizData, questions: newQuestions });
  };

  const updateQuestionOption = (qIndex, optIndex, value) => {
    const newQuestions = [...quizData.questions];
    newQuestions[qIndex].options[optIndex] = value;
    setQuizData({ ...quizData, questions: newQuestions });
  };

  const toggleUserAssignment = (userEmail) => {
    const newAssignedUsers = quizData.assigned_users.includes(userEmail)
      ? quizData.assigned_users.filter(email => email !== userEmail)
      : [...quizData.assigned_users, userEmail];
    setQuizData({ ...quizData, assigned_users: newAssignedUsers });
  };

  const generateQuestionsWithAI = async () => {
    if (!quizData.topic) {
      setError("Please enter a topic first");
      return;
    }

    setCreating(true);
    setError("");

    try {
      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `Create 10 multiple choice questions about ${quizData.topic} for B.Tech students.
        Difficulty level: ${quizData.difficulty}.
        Each question should:
        - Be clear and specific
        - Have exactly 4 options
        - Have only one correct answer
        - Include a detailed explanation for the correct answer
        - Cover important concepts in ${quizData.topic}`,
        response_json_schema: {
          type: "object",
          properties: {
            questions: {
              type: "array",
              items: {
                type: "object",
                properties: {
                  question: { type: "string" },
                  options: { type: "array", items: { type: "string" } },
                  correct_answer: { type: "string" },
                  explanation: { type: "string" }
                }
              }
            }
          }
        }
      });

      setQuizData({
        ...quizData,
        title: quizData.title || `${quizData.topic} Quiz`,
        questions: result.questions
      });
      setSuccess("Questions generated successfully!");
    } catch (err) {
      setError("Failed to generate questions. Please try again.");
      console.error(err);
    }

    setCreating(false);
  };

  const createQuiz = async () => {
    setError("");
    setSuccess("");

    // Validation
    if (!quizData.title || !quizData.topic) {
      setError("Please fill in title and topic");
      return;
    }

    const validQuestions = quizData.questions.filter(q => 
      q.question && q.options.every(o => o) && q.correct_answer && q.explanation
    );

    if (validQuestions.length === 0) {
      setError("Please add at least one complete question");
      return;
    }

    if (!quizData.is_public && quizData.assigned_users.length === 0) {
      setError("Please assign users or make the quiz public");
      return;
    }

    setCreating(true);

    try {
      await base44.entities.Quiz.create({
        title: quizData.title,
        topic: quizData.topic,
        difficulty: quizData.difficulty,
        duration_minutes: quizData.duration_minutes,
        questions: validQuestions,
        total_questions: validQuestions.length,
        assigned_users: quizData.assigned_users,
        is_public: quizData.is_public,
        created_by_admin: currentUser.email
      });

      setSuccess("Quiz created successfully!");
      
      // Reset form
      setTimeout(() => {
        setQuizData({
          title: "",
          topic: "",
          difficulty: "medium",
          duration_minutes: 15,
          questions: [
            { question: "", options: ["", "", "", ""], correct_answer: "", explanation: "" }
          ],
          assigned_users: [],
          is_public: false
        });
        setSuccess("");
      }, 2000);
    } catch (err) {
      setError("Failed to create quiz. Please try again.");
      console.error(err);
    }

    setCreating(false);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-purple-50 to-indigo-50 py-8 px-4">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center gap-3 mb-2">
            <Shield className="w-8 h-8 text-purple-600" />
            <h1 className="text-4xl font-bold text-slate-800">Create & Assign Quiz</h1>
          </div>
          <p className="text-slate-600">Create custom quizzes and assign them to specific students</p>
        </div>

        {error && (
          <Alert variant="destructive" className="mb-6">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}

        {success && (
          <Alert className="mb-6 bg-green-50 border-green-200">
            <AlertDescription className="text-green-800">{success}</AlertDescription>
          </Alert>
        )}

        {/* Basic Info */}
        <Card className="shadow-xl mb-6">
          <CardHeader>
            <CardTitle>Quiz Information</CardTitle>
            <CardDescription>Basic details about the quiz</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Quiz Title *</Label>
                <Input
                  placeholder="e.g., Data Structures Final Test"
                  value={quizData.title}
                  onChange={(e) => setQuizData({ ...quizData, title: e.target.value })}
                />
              </div>
              <div className="space-y-2">
                <Label>Topic *</Label>
                <Input
                  placeholder="e.g., Data Structures & Algorithms"
                  value={quizData.topic}
                  onChange={(e) => setQuizData({ ...quizData, topic: e.target.value })}
                />
              </div>
              <div className="space-y-2">
                <Label>Difficulty</Label>
                <Select value={quizData.difficulty} onValueChange={(v) => setQuizData({ ...quizData, difficulty: v })}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="easy">Easy</SelectItem>
                    <SelectItem value="medium">Medium</SelectItem>
                    <SelectItem value="hard">Hard</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>Duration (minutes)</Label>
                <Input
                  type="number"
                  value={quizData.duration_minutes}
                  onChange={(e) => setQuizData({ ...quizData, duration_minutes: parseInt(e.target.value) })}
                />
              </div>
            </div>

            <div className="flex items-center space-x-2">
              <Checkbox
                id="public"
                checked={quizData.is_public}
                onCheckedChange={(checked) => setQuizData({ ...quizData, is_public: checked })}
              />
              <Label htmlFor="public" className="cursor-pointer">
                Make this quiz available to all users
              </Label>
            </div>
          </CardContent>
        </Card>

        {/* Assign Users */}
        {!quizData.is_public && (
          <Card className="shadow-xl mb-6">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Users className="w-5 h-5" />
                Assign to Users
              </CardTitle>
              <CardDescription>Select users who can take this quiz</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid md:grid-cols-3 gap-4 max-h-64 overflow-y-auto">
                {users.map((user) => (
                  <div key={user.id} className="flex items-center space-x-2">
                    <Checkbox
                      id={user.id}
                      checked={quizData.assigned_users.includes(user.email)}
                      onCheckedChange={() => toggleUserAssignment(user.email)}
                    />
                    <Label htmlFor={user.id} className="cursor-pointer text-sm">
                      <div className="font-medium">{user.full_name || 'Unknown'}</div>
                      <div className="text-xs text-slate-500">{user.email}</div>
                    </Label>
                  </div>
                ))}
              </div>
              {quizData.assigned_users.length > 0 && (
                <div className="mt-4 pt-4 border-t">
                  <p className="text-sm text-slate-600">
                    Selected: <span className="font-semibold">{quizData.assigned_users.length}</span> user(s)
                  </p>
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Questions */}
        <Card className="shadow-xl mb-6">
          <CardHeader>
            <div className="flex justify-between items-center">
              <div>
                <CardTitle className="flex items-center gap-2">
                  <BookOpen className="w-5 h-5" />
                  Quiz Questions
                </CardTitle>
                <CardDescription>Add questions manually or generate with AI</CardDescription>
              </div>
              <Button
                onClick={generateQuestionsWithAI}
                disabled={creating || !quizData.topic}
                variant="outline"
              >
                <Sparkles className="w-4 h-4 mr-2" />
                Generate with AI
              </Button>
            </div>
          </CardHeader>
          <CardContent className="space-y-6">
            {quizData.questions.map((question, qIndex) => (
              <div key={qIndex} className="p-4 border-2 border-slate-200 rounded-lg bg-slate-50">
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-semibold text-slate-800">Question {qIndex + 1}</h4>
                  {quizData.questions.length > 1 && (
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => removeQuestion(qIndex)}
                    >
                      <Trash2 className="w-4 h-4 text-red-500" />
                    </Button>
                  )}
                </div>

                <div className="space-y-4">
                  <div className="space-y-2">
                    <Label>Question *</Label>
                    <Textarea
                      placeholder="Enter your question..."
                      value={question.question}
                      onChange={(e) => updateQuestion(qIndex, 'question', e.target.value)}
                    />
                  </div>

                  <div className="grid md:grid-cols-2 gap-4">
                    {question.options.map((option, oIndex) => (
                      <div key={oIndex} className="space-y-2">
                        <Label>Option {String.fromCharCode(65 + oIndex)} *</Label>
                        <Input
                          placeholder={`Option ${String.fromCharCode(65 + oIndex)}`}
                          value={option}
                          onChange={(e) => updateQuestionOption(qIndex, oIndex, e.target.value)}
                        />
                      </div>
                    ))}
                  </div>

                  <div className="space-y-2">
                    <Label>Correct Answer *</Label>
                    <Select
                      value={question.correct_answer}
                      onValueChange={(v) => updateQuestion(qIndex, 'correct_answer', v)}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Select correct answer" />
                      </SelectTrigger>
                      <SelectContent>
                        {question.options.map((option, i) => (
                          <SelectItem key={i} value={option} disabled={!option}>
                            {String.fromCharCode(65 + i)}: {option || '(empty)'}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label>Explanation *</Label>
                    <Textarea
                      placeholder="Explain why this is the correct answer..."
                      value={question.explanation}
                      onChange={(e) => updateQuestion(qIndex, 'explanation', e.target.value)}
                    />
                  </div>
                </div>
              </div>
            ))}

            <Button onClick={addQuestion} variant="outline" className="w-full">
              <Plus className="w-4 h-4 mr-2" />
              Add Another Question
            </Button>
          </CardContent>
        </Card>

        {/* Create Button */}
        <div className="flex justify-end gap-4">
          <Button variant="outline" onClick={() => navigate(createPageUrl("AdminDashboard"))}>
            Cancel
          </Button>
          <Button
            onClick={createQuiz}
            disabled={creating}
            className="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700"
          >
            {creating ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" />
                Creating...
              </>
            ) : (
              <>
                <Save className="w-4 h-4 mr-2" />
                Create Quiz
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  );
}
